<!doctype html>
<html>
    <head>
        <title>Podrida</title>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <script src="http://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
        <script>
            $(function () {
                var on = false;
                window.setInterval(function () {
                    on = !on;
                    if (on) {
                        $('.invalid').addClass('invalid-blink')
                    } else {
                        $('.invalid-blink').removeClass('invalid-blink')
                    }
                }, 500);
            });</script>
        <script type="text/javascript">
            window.onbeforeunload = function () {
                return "Seguro?";
            };
        </script>
        <script type="text/javascript">
            function onLoadFunction() {
                $("#configDiv").hide();
                $("#pregameContainer").hide();
                $("#gameContainer").hide();
                vaciarMensaje();
            }
        </script>
        <script type="text/javascript">
            var heartbeatStatus = true;
            var userId;
            var username;
            var orden;
            var cantCandidatos = 0;
            var jugadores = [];
            var estadisticasPedidas = [];
            var imagenesCartas;
            var jugable = false;
            var pedidas = 0;
            var cantBazas = 0;
            var cantCartas = 0;
            var repartidor = 0;
            var sndEnabled = false;
            var recursosSolicitados = false;
            var recursosDescargados = false;
            function processIncomingMessage(rawMsg) {
                var msg = JSON.parse(rawMsg);
                var status = msg.status;
                var code = msg.code;
                var content = msg.content;
                switch (code) {
                    case 0:
                        processJoinGameReply(status, content);
                        break;
                    case 1:
                        processGetPlayersReply(status, content);
                        break;
                    case 2:
                        processStartGameReply(status, content);
                        break;
                    case 3:
                        processGetTableReply(status, content);
                        break;
                    case 4:
                        processPlayCardReply(status, content);
                        break;
                    case 5:
                        processChooseNumberReply(status, content);
                        break;
                    case 6:
                        processDealReply(status, content);
                        break;
                    case 7:
                        mensaje(content);
                        break;
                    case 8:
                        processVerEstadisticasReply(status, content);
                        break;
                    case 9:
                        processVerEstadisticasUsuarioReply(status, content);
                        break;
                    case 10:
                        processGameConfigReply(status, content);
                        break;
                    case 11:
                        processEspectadorReply(status, content);
                        break;
                    case 80:
                        chatMessage(status, content);
                        break;
                    case 90:
                        processConnectionChange(status, content);
                        break;
                    case 91:
                        processKickReply(status, content);
                        break;
                    case 92:
                        processRestartSuggestion(status, content);
                        break;
                    case 93:
                        processForcedPlay(status, content);
                        break;
                    case 95:
                        processHeartbeatReply(status, content);
                        break;
                    default:
                        mensaje(content);
                }
                ;
            }
            ;
            function processJoinGameReply(status, content) {
                if (status) {
                    var reply = JSON.parse(content);
                    setTimeout(heartbeat,7500);
                    if (reply.hasOwnProperty('username')) {
//                        userId = reply.userId;
                        username = reply.username;
                        mensaje("Conectado, esperando otros jugadores.");
                        $("#loginContainer").remove();
                        $("#pregameContainer").show();
                    } else {
                        mensaje("Restaurando juego, por favor esperar la descarga de los recursos");
                        recargarDatosJuego(reply.datos);
                        ;
                    }
                } else {
                    socket.close();
                    mensaje(content);
                    //                alert(content);
                    $("#loginButton").prop('disabled', false);
                }
            }
            ;
            function processGetPlayersReply(status, content) {
                if (status) {
                    var players = JSON.parse(content);
                    cantCandidatos = players.length;
                    var html = "<table class='bordered padded'><th class='bordered padded'>Nombre</th><th class='bordered padded'>Estado</th>";
                    $("#configDiv").hide();
                    for (var x in players) {
                        html += "<tr class='bordered padded'>";
                        if (x > 1) {
                            jugable = true;
                        }
                        var user = players[x];
                        html += "<td class='bordered padded'>" + user.name + "</td>";
                        html += "<td class='bordered padded'>" + (user.status ? "Listo para empezar ya" : "Esperando otros jugadores...") + "</td>";
                        html += "</tr>";
                        if (x == 0 && (user.name === username)) {
                            $("#configDiv").show();
                            cambiarMaximoBazasPosible();
                        }
                    }
                    html += "</table>";
                    $("#listaJugadores").empty().append(html);
                    vaciarMensaje(content);
                } else {
                    mensaje(content);
                }
            }
            ;
            function processEspectadorReply(status, content) {
                if (status) {
                    var data = JSON.parse(content);
                    setTimeout(heartbeat,7500);
                    recargarDatosJuego(data);
                } else {
                    mensaje(content);
                }
            }
            ;
            function processGameConfigReply(status, content) {
                if (status) {
                    $("#configInfo").empty().append(content);
                    mensaje("Se ha cambiado la configuracion del juego.");
                } else {
                    mensaje(content);
                }
            }
            ;
            function processStartGameReply(status, content) {
                if (status) {
                    mensaje("Cargando, por favor esperar la descarga de los recursos...");
                    startGame(content);
                } else {
                    mensaje(content);
                }
            }
            ;
            function processGetTableReply(status, content) {
                if (status) {
                    var reply = JSON.parse(content);
                    closeTable();
                    var htmlContent = "<button onclick='closeTable()'>CERRAR TABLA</button>";
                    htmlContent += "<table class='bordered padded'>";
                    for (var x in reply) {
                        var array = reply[x];
                        var firstSquare = array[0];
                        htmlContent += "<tr class='bordered padded'>";
                        htmlContent += "<td class='bordered padded'>" + firstSquare + "</td>";
                        if (isNaN(firstSquare)) { //row de texto
                            for (var y = 1; y < array.length; y++) {
                                htmlContent += "<td align='center' class='bordered padded' colspan='2'>" + array[y] + "</td>";
                            }
                        } else { //row de puntos
                            for (var y = 1; y < array.length; y++) {
                                var jo = array[y];
                                htmlContent += "<td align='center' ";
                                if (jo.puntera) {
                                    htmlContent += "bgcolor='#A0FFA0' ";
                                } else if (jo.ultima) {
                                    htmlContent += "bgcolor='#FFA0A0' ";
                                } else {
                                    htmlContent += "bgcolor='#FFFFFF' ";
                                }
                                htmlContent += "class='bordered padded";
                                if (jo.tachado) {
                                    htmlContent += " crossed";
                                }
                                htmlContent += "'>";
                                htmlContent += jo.acumulado;
                                htmlContent += "</td>";
                                htmlContent += "<td align='center'>";
                                htmlContent += jo.bazas + "/" + jo.pedido;
                                htmlContent += "</td>";
                            }
                        }
                        htmlContent += "</tr>";
                    }
                    htmlContent += "</table>";
                    htmlContent += "<button onclick='closeTable()'>CERRAR TABLA</button>";
                    $("#tableContainer").empty().append(htmlContent);
                } else {
                    mensaje(content);
                }
            }
            ;
            function processPlayCardReply(status, content) {
                if (status) {
                    var reply = JSON.parse(content);
                    mensaje(jugadores[reply.jugador] + " jugo la carta " + reply.cartaJugada.substring(1));
                    cardPlayed(reply.jugador, reply.cartaJugada, false);
                    setTurn(reply.turnoActual);
                    if (reply.hasOwnProperty('ganadorBaza')) {
                        if (reply.hasOwnProperty('puntajes')) {
                            if (reply.hasOwnProperty('end')) { //ultima baza de la ultima ronda terminada
                                addBaza(reply.ganadorBaza, reply.bazasActuales);
                                updateScores(reply.puntajes);
                                mensaje("Fin del juego!");
                                cantCartas = 0;
                                setTimeout(verTabla, 2000);
                                setTimeout(setRecursosDescargados, 2000, false);
                                setTimeout(mensaje, 2200, "Imagenes de naipes cortesia de .com/nallera");
                            } else { //ultima baza de esta ronda terminada
                                addBaza(reply.ganadorBaza, reply.bazasActuales);
                                updateScores(reply.puntajes);
                                repartidor = reply.turnoActual;
                                if (reply.turnoActual == orden) {
                                    mensaje("Te toca repartir");
                                    setTimeout(solicitarRepartirClick, 2000);
                                }
                            }
                        } else { //baza normal terminada
                            addBaza(reply.ganadorBaza, reply.bazasActuales);
                            setTurn(reply.turnoActual);
                            if (reply.turnoActual == orden) {
                                //deberia ser yo si gane la baza
                                playSound();
                                mensaje("Te toca tirar");
                            }
                            setTimeout(clearPlayedCards,2000);
                        }
                    } else { //proxima jugada de esta baza
                        if (reply.turnoActual == orden) {
                            playSound();
                            mensaje("Te toca tirar");
                        }
                    }
                } else {
                    mensaje(content);
                }
            }
            ;
            function processChooseNumberReply(status, content) {
                if (status) {
                    var reply = JSON.parse(content);
                    var apodoNumero;
                    pedidas += reply.numero;
                    prohibido = cantBazas - pedidas;
                    var mensajeMaximo = "<br>no podria<br>pedir " + prohibido;
                    if (prohibido < 0) {
                        mensajeMaximo = "<br>puede pedir<br>cualquiera";
                    }
                    document.getElementById("indicadorBazas").innerHTML = (cantBazas * jugadores.length) + "/" + cantCartas + "<br>cartas en juego<br>Pedidas: " + pedidas + "/" + cantBazas + "<br>" + jugadores[repartidor] + mensajeMaximo;

                    switch (reply.numero) {
                        case 0:
                            apodoNumero = "serapioo";
                            break;
                        case 1:
                            apodoNumero = "unescooo";
                            break;
                        case 2:
                            apodoNumero = "duquesaa";
                            break;
                        case 3:
                            apodoNumero = "tricotaa";
                            break;
                        case 4:
                            apodoNumero = "cuaternaa";
                            break;
                        case 5:
                            apodoNumero = "kentuckyy";
                            break;
                        case 6:
                            apodoNumero = "hexapiii";
                            break;
                        default:
                            apodoNumero = reply.numero;
                    }
                    mensaje(jugadores[reply.jugador] + " eligio " + apodoNumero);
                    setTurn(reply.turnoActual);
                    setBaza(reply.jugador, reply.numero);
                    if (reply.hasOwnProperty("mensaje")) {
                        document.getElementById("botonesPedido").remove();
                        mensaje(reply.mensaje);
                        document.getElementById("indicadorBazas").innerHTML = (cantBazas * jugadores.length) + "/" + cantCartas + "<br>cartas en juego<br>Pedidas: " + pedidas + "/" + cantBazas + "<br>" + reply.mensaje;
                        if (reply.turnoActual == orden) {
                            playSound();
//                            mensaje("Te toca tirar");
                        }
                    } else {
                        if (reply.turnoActual == orden) {
                            playSound();
                            if (reply.hasOwnProperty("numeroNoValido")) {
                                mensaje("Te toca elegir un numero. No puede ser el " + reply.numeroNoValido);
                            } else {
                                mensaje("Te toca elegir un numero cualquiera.");
                            }
                        }
                    }
                } else {
                    mensaje(content);
                }
            }
            ;

            function processDealReply(status, content) {
                if (status) {
                    var reply = JSON.parse(content);
                    setTurn(reply.turnoActual);
                    pedidas = 0;
                    clearPlayedCards();
                    if (reply.hasOwnProperty('rondaIndia')) {
                        createIndianCardSpace(reply.cartasJugadores);
                    } else {
                        createCardSpace(reply.cartas);
                    }
                    if (reply.turnoActual == orden) {
                        playSound();
                        mensaje("Te toca elegir un numero");
                    }
                } else {
                    mensaje(content);
                }
            }
            ;

            function closeTable() {
                estadisticasPedidas=[];
                $("#tableContainer").empty().append("-");
            }

            function vaciarMensaje() {
                $("#responseContainer").empty().append("-");
            }
            ;

            function chatMessage(status, content) {
                if (status) {
                    var oldChat = $("#chatContainerNew").html();
                    $("#chatContainerOld").empty().append(oldChat);
                    $("#chatContainerNew").empty().append(content);
                } else {
                    mensaje(content);
                }
            }
            ;
            function processConnectionChange(status, content) {
                if (status) {
                    var datos = JSON.parse(content);
                    var element = document.getElementById("square_" + datos.nombre);
                    if(element !== undefined && element !== null){
                        if (datos.conexion) {
                            mensaje(datos.nombre + ' se reconecto');
                            element.classList.remove("crossed");
                        } else {
                            mensaje(datos.nombre + ' ha perdido conexion');
                            element.classList.add("crossed");
                        }
                    }
                } else {
                    mensaje(content);
                }
            }
            ;
            function recargarDatosJuego(datos) {
//                var datos = JSON.parse(data);
                if (!recursosDescargados) {
                    mensajeAppend(".");
                    setTimeout(recargarDatosJuego, 100, data);
                    return;
                }
                $("#loginContainer").remove();
                $("#pregameContainer").remove();

                cantCartas = datos.cantCartas;
                userId = datos.userId;
                username = datos.username;
                pedidas = datos.pedidas;
                estadisticasPedidas = [];
                sndEnabled = false;
                jugable = true;
                prepararTablero(datos.tablero);
                datosJugadores = datos.datosJugadores;
                for (var x in datosJugadores) {
                    var datosJugador = datosJugadores[x];
                    var nombreJugador = datosJugador.nombre;
                    if (nombreJugador === username) {
                        orden = x;
                    }
                    jugadores.push(nombreJugador);
                    cardPlayedNamed(nombreJugador, datosJugador.cartaJugada, false);
                    if (datosJugador.bazasPedidas !== -1) {
                        setBazaNamed(nombreJugador, datosJugador.bazasPedidas);
                        addBazaNamed(nombreJugador, datosJugador.bazasGanadas);
                    }
                }
                createCardSpace(datos.cartas);
                if (datos.turno == orden) {
                    setTimeout(solicitarRepartirClick, 2000);
                }
//                if (username === undefined) {
//                    console.log("deshabilitar todos los botones");
//                }
                setTurn(datos.turno);
                $("#gameContainer").show();
            }
            ;
            function mensaje(msg) {
                $("#responseContainer").empty().append(msg);
            }
            ;
            function mensajeAppend(msg) {
                $("#responseContainer").append(msg);
            }
            ;

            var socket = null;
            function socketSend(msg) {
                if (socket !== null) {
                    //socket.readtState:
                    //0 – “CONNECTING”: the connection has not yet been established,
                    //1 – “OPEN”: communicating,
                    //2 – “CLOSING”: the connection is closing,
                    //3 – “CLOSED”: the connection is closed.
                    var mens = JSON.stringify(msg);
                    socket.send(mens);
                } else {
                    mensaje("No se encontro conexion");
                    return false;
                }
                return true;
            }
            ;

            function startGame(param) {
                if (!recursosDescargados) {
                    mensajeAppend(".");
                    setTimeout(startGame, 100, param);
                    return;
                }
                vaciarMensaje();
                $("#pregameContainer").remove();
                $("#gameContainer").show();
                var reply = JSON.parse(param);
                cantCartas = reply.cantCartas;
                jugadores = reply.jugadores;
                for (var x in jugadores) {
                    if (jugadores[x] === username) {
                        orden = x;
                        break;
                    }
                }
                prepararTablero(reply.tablero);
                setTurn(0);
                repartidor = 0;
                if (orden == 0) {
                    mensaje("Te toca repartir");
                    setTimeout(solicitarRepartirClick, 2000);
                }
            }
            ;

            function prepararTablero(tablero) {
                $("#gameContainer").empty();
                $("#gameContainer").append(tablero);
                if (username !== undefined) {
                    remarcarCuadroTablero();
                }
                clearPlayedCards();
            }
            ;
            function remarcarCuadroTablero() {
                document.getElementById("table_" + username).classList.add("thick-bordered");
                document.getElementById("table_" + username).classList.remove("bordered");
            }
            ;
            function clearPlayedCards() {
                for (var x in jugadores) {
                    var element = document.getElementById("img_" + jugadores[x]);
                    element.innerHTML = getImagenCarta("blank");
                    element.classList.add("padded");
                }
            }
            ;
            function getImagenCarta(carta) {
                if (carta === "blank") {
                    if (imagenesCartas === undefined || imagenesCartas[carta] === undefined) {
                        return "<img alt='-'/>";
                    }
                    return imagenesCartas[carta];
                }
                if (carta === "unknown") {
                    if (imagenesCartas === undefined || imagenesCartas[carta] === undefined) {
                        return "<img alt='?'/>";
                    }
                    return imagenesCartas[carta];
                }
                if (imagenesCartas === undefined || imagenesCartas[carta.substring(1)] === undefined) {
                    return "<img alt='" + carta.substring(1) + "'/>";
                }
                return imagenesCartas[carta.substring(1)];
            }
            ;
            function cardPlayed(jugador, carta, transparent) {
                cardPlayedNamed(jugadores[jugador], carta, transparent);
            }
            ;
            function cardPlayedNamed(jugador, carta, transparent) {
                var element = document.getElementById("img_" + jugador);
                element.innerHTML = getImagenCarta(carta);
                document.getElementById("img_" + jugador)
                if (carta === "blank") {
                    element.classList.add("padded");
                } else {
                    element.classList.remove("padded");
                    if (transparent) {
                        element.classList.add("transparent");
                    } else {
                        element.classList.remove("transparent");
                    }
                }
                var elem = document.getElementById("card_" + carta);
                //quito la carta del cardspace      
                if (elem !== undefined && elem !== null) {
                    elem.innerHTML = getImagenCarta("blank");
                    elem.classList.add("padded");
                }
                //en el caso de que fuera carta unknown, la quito tambien
                if (jugador === username) {
                    var indianElem = document.getElementById("card_unknown");
                    if (indianElem !== undefined && indianElem !== null) {
                        indianElem.innerHTML = getImagenCarta("blank");
                        indianElem.classList.add("padded");
                    }
                }
            }
            ;
            function cambiarMaximoBazasPosible() {
                var cantBarajasElegida = $("#cantBarajas").val();
                var min = 3;
                var max = Math.floor((cantBarajasElegida * 40) / cantCandidatos);

                var select = document.getElementById("cantBazasMaximaForzada");

                $("#cantBazasMaximaForzada").empty();
                for (var i = max; i >= min; i--) {
                    var option = document.createElement("option");
                    option.text = i;
                    select.add(option);
                }
            }
            ;
            function updateScores(puntajes) {
                borrarBazasElegidas();
                for (var x in jugadores) {
                    var nombreJugador = jugadores[x];
                    var puntajeJugador = puntajes[nombreJugador];
                    var puntajeJugadorDom = document.getElementById("pts_" + nombreJugador);
                    puntajeJugadorDom.innerHTML = puntajeJugador.total;
                    if (puntajeJugador.puntero) {
                        puntajeJugadorDom.setAttribute("bgcolor", '#A0FFA0');
                    } else if (puntajeJugador.ultimo) {
                        puntajeJugadorDom.setAttribute("bgcolor", '#FFA0A0');
                    } else {
                        puntajeJugadorDom.setAttribute("bgcolor", '#FFFFFF');
                    }
                }
            }
            ;
            function borrarBazasElegidas() {
                for (var x in jugadores) {
                    var elem = document.getElementById("bazas_" + jugadores[x]);
                    elem.innerHTML = "-";
                    elem.setAttribute("bgcolor", '#FFFFFF');
                }
            }
            ;
            function setBaza(jugador, valor) {
                setBazaNamed(jugadores[jugador], valor);
            }
            ;
            function setBazaNamed(jugador, valor) {
                var elem = document.getElementById("bazas_" + jugador);
                elem.innerHTML = "0/" + valor;
                elem.setAttribute("bgcolor", valor === 0 ? '#A0FFA0' : '#FFA0A0');
            }
            ;
            function addBaza(jugador, cant) {
                addBazaNamed(jugadores[jugador], cant);
            }
            ;
            function addBazaNamed(jugador, cant) {
                var elem = document.getElementById("bazas_" + jugador);
                var elems = elem.innerHTML.split("/");
                var pedido = Number(elems[1]);
                elem.innerHTML = cant + "/" + pedido;
                elem.setAttribute("bgcolor", cant === pedido ? '#A0FFA0' : '#FFA0A0');
            }
            ;
//            function addBaza(jugador) {
//                var elem = document.getElementById("bazas_" + jugadores[jugador]);
//                var elems = elem.innerHTML.split("/");
//                var nuevoValor = Number(elems[0]) + 1;
//                var pedido = Number(elems[1]);
//                elem.innerHTML = nuevoValor + "/" + pedido;
//                elem.setAttribute("bgcolor", nuevoValor === pedido ? '#A0FFA0' : '#FFA0A0');
//            }
//            ;

            function toggleSound() {
                sndEnabled = !sndEnabled;
            }
            ;

            function playSound() {
                if (sndEnabled) {
                    document.getElementById('buzzer').play();
                }
            }
            ;

            function setTurn(jugador) {
                for (var x in jugadores) {
                    var element = document.getElementById("img_" + jugadores[x]);
                    element.classList.remove("invalid");
                }
                if (jugador !== -1) {
                    document.getElementById("img_" + jugadores[jugador]).classList.add("invalid");
                }
            }
            ;
            function createIndianCardSpace(cartasJugadores) {
                for (var x in cartasJugadores) {
                    cardPlayedNamed(x, cartasJugadores[x], true);
                }
                createCardSpace(["unknown"]);
            }
            ;
            function createCardSpace(cartasAMostrar) {
                cantBazas = cartasAMostrar.length;
                document.getElementById("indicadorBazas").innerHTML = (cantBazas * jugadores.length) + "/" + cantCartas + "<br>cartas en juego<br>Pedidas: " + pedidas + "/" + cantBazas;
                var appendable = "";
//                appendable += "<button onclick='solicitarRepartirClick()'>REPARTIR</button>";
                appendable += "<button onclick='mensajeEstandar(0)'>AGUITA</button>";
                appendable += "<button onclick='mensajeEstandar(1)'>JUGARON MAL</button>";
                appendable += "<button onclick='mensajeEstandar(2)'>SI JUGAMOS BIEN</button>";
                appendable += "<button onclick='mensajeEstandar(3)'>FARAONICO</button>";
                appendable += "<button onclick='mensajeEstandar(4)'>ASI NO</button>";
                appendable += "<button onclick='mensajeEstandar(5)'>LA QUIERE</button>";
                appendable += "<button onclick='verTabla()'>TABLA</button>";
                appendable += "<button onclick='sendChatClick()'>CHAT</button>";
                appendable += "<button disabled onclick='reset()'>REINICIAR</button>";
                appendable += "<input onclick='toggleSound()' type='checkbox'";
                if (sndEnabled) {
                    appendable += " checked ";
                }
                appendable += ">SONIDO";
                appendable += "<table>";
                for (var x in cartasAMostrar) {
                    appendable += "<td onmouseover='' style='cursor: pointer;' id='card_" + cartasAMostrar[x] + "' onclick='solicitarTirarClick(\"" + cartasAMostrar[x] + "\")' align='center' class='bordered'>" + getImagenCarta(cartasAMostrar[x]) + "</td>";
                }
                appendable += "</tr><tr id='botonesPedido'>";
                for (var i = 0; i <= cartasAMostrar.length; i++) {
                    appendable += "<td><button style='width:100%;' id='choose_" + i + "' onclick='solicitarElegirClick(" + i + ")'>Pedir ";
                    appendable += i;
                    appendable += "</button></td>";
                }
                appendable += "</tr></table><br>";
                $("#cardSpace").empty().append(appendable);
            }
            ;

            function solicitarTirarClick(carta) {
                if(username === undefined){
                    return;
                }
                vaciarMensaje();
                mensaje("Enviando " + carta);
                var data = {id: userId, com: "4", param: carta};
                socketSend(data);
            }
            ;

            function solicitarElegirClick(n) {
                if(username === undefined){
                    return;
                }
                vaciarMensaje();
                mensaje("Pidiendo llevarse " + n);
                var data = {id: userId, com: "5", param: n};
                socketSend(data);
            }
            ;

            function solicitarRepartirClick() {
                vaciarMensaje();
                mensaje("Repartiendo....");
                var data = {id: userId, com: "6", param: ""};
                socketSend(data);
            }
            ;

            function mensajeEstandar(param) {
                if (isNaN(param)) {
                    return;
                }
                vaciarMensaje();
                var data = {id: userId, com: "7", param: param};
                socketSend(data);
            }
            ;

            function verTabla() {
                vaciarMensaje();
                var data = {id: userId, com: "3", param: ""};
                socketSend(data);
            }
            ;

            function sendChatClick() {
                var param = prompt("Mensaje a enviar");
                if (param != null) {
                    var data = {id: userId, com: "80", param: param};
                    socketSend(data);
                }
            }
            ;

            function configurarJuegoClick() {
                var params = {"ultimaRondaIndia": document.getElementById("ultimaRondaIndiaChk").checked, "cantBarajas": $("#cantBarajas").val(), "cantBazasMaximaForzada": $("#cantBazasMaximaForzada").val()};
                var data = {id: userId, com: "10", param: JSON.stringify(params)};
                socketSend(data);
            }
            ;

            function solicitarIniciarClick() {
                if (jugable) {
                    vaciarMensaje();
                    $("#solicitarIniciarButton").prop('disabled', true);
                    mensaje("Marcaste listo para empezar!");
                    var data = {id: userId, com: "2", param: ""};
                    socketSend(data);
                } else {
                    mensaje("Aun no hay suficientes jugadores");
                }
            }
            ;
            function openSocket(token) {
                try {
                    //        let
                    socket = new WebSocket("ws:" + window.location.hostname + ":###WS_PORT###");
                } catch (e) {
                    mensaje(e.message);
                    return;
                }
                socket.onopen = function (e) { //esto se dispara ni bien se abre el socket
                    vaciarMensaje();
                    if (token === "") { //espectador
                        var data = {id: token, com: "11", param: ""};
                    } else {
                        var data = {id: token, com: "0", param: ""};
                    }
                    socketSend(data);
                };
                socket.onmessage = function (event) { //se dispara al recibir datos del server
                    processIncomingMessage(event.data);
                };
                socket.onclose = function (event) {
                    if (event.wasClean) {
                        mensaje("Se cerro correctamente la conexion");
                    } else {
//                        mensaje("Se cerro inesperadamente la conexion: codigo " + event.code);
                    }
                    $("#loginButton").prop('disabled', false);
                    socket = null;
                };
                socket.onerror = function (error) {
                    var msg = error.message;
                    if (msg === undefined) {
                        msg = "Error en la conexion";
                        socket = null;
                    }
                    mensaje(msg);
                };
            }
            ;
            function heartbeat(){
                if(heartbeatStatus){
                    heartbeatStatus = false;
                    var data = {id: username, com: "95", param: ""};
                    setTimeout(heartbeat,7500);
                    socketSend(data);
                } else {
                    if(username !== undefined){
                        var elem = document.getElementById("square_" + username);
                        if(elem !== undefined && elem !== null){
                            elem.classList.add("crossed");
                        }
                    }
                    alert("Se ha perdido la conexion. Refresque el navegador e ingrese nuevamente.");
//                    openSocket(username);
                }
            };
            function processHeartbeatReply(){
              heartbeatStatus = true;
            };
            function leaderboardButtonClick() {
                vaciarMensaje();
                var data = {id: userId, com: "8", param: ""};
                socketSend(data);
            }
            ;
            function processVerEstadisticasReply(status, content) {
                if (status) {
                    console.log(content);
                } else {
                    mensaje(content);
                }
            }
            ;
            function spectatorButtonClick() {
                if (recursosSolicitados) {
                    if (recursosDescargados) {
                        openSocket("");
                    } else {
                        mensajeAppend(".");
                        setTimeout(spectatorButtonClick, 100, token);
                    }
                } else {
                    descargarRecursos();
                    enterGame("");
                }
            }
            ;
            function processKickReply(nombre){
                if(username === undefined){
                    return;
                }
                if(document.getElementById("square_" + nombre).classList.contains("crossed")){
                    vaciarMensaje();
                    var data = {id: userId, com: "91", param: nombre};
                    socketSend(data);
                } else {
                    mensaje("No se puede echar a un jugador con conexion activa!");
                }
            };
            function processRestartSuggestion(status,content){
                if (status) {
                    alert("Se solicito reiniciar el juego");
                } else {
                    mensaje(content);
                }
            };
            function processForcedPlay(status,content){
                if (status) {
                    alert("Se pidio jugar forzadamente");
                } else {
                    mensaje(content);
                }
            };
            function reset(){
                if(username === undefined){
                    return;
                }
                if (confirm("Reiniciar juego?")) {
                    var data = {id: username, com: "95", param: ""};
                    socketSend(data);
                    alert("Aun no implementado");
//                  enviar post de RESET, solo ocurrira si todos los jugadores activos aprietan alli en un lapso adecuado
                }
            };
            function verEstadisticasUsuario(nombre){
                vaciarMensaje();
                estadisticasPedidas.push(nombre);
                var data = {id: userId, com: "9", param: JSON.stringify(estadisticasPedidas)};
                socketSend(data);
            };
            function processVerEstadisticasUsuarioReply(status, content) {
                if (status) {
                    var data = JSON.parse(content);
                    if(estadisticasPedidas.length === 0){
                        closeTable();
                    }
                    var htmlContent = "<button onclick='closeTable()'>CERRAR TABLA</button>";
                    htmlContent += "<table class='bordered padded'>";
                    for(var x in data){
                        htmlContent += data[x];
                    }
                    htmlContent += "</table>";
                    htmlContent += "<button onclick='closeTable()'>CERRAR TABLA</button>";
                    $("#tableContainer").empty().append(htmlContent);
                } else {
                    mensaje(content);
                }
            }
            ;
            function descargarRecursos() {
                recursosSolicitados = true;
                mensaje("Descargando recursos");
                $.post('http://' + window.location.host + '/podrida?resources').done(function (data) {
                    var reply = JSON.parse(data);
                    if (reply.status) {
                        var content = JSON.parse(reply.content);
                        var sonido = content.sound;
                        imagenesCartas = content.cards;
                        $("#audioDiv").append(sonido.soundfile);
                        setRecursosDescargados(true);
                    } else {
                        mensaje("Error de conexion");
                        recursosSolicitados = false;
                    }
                }).fail(function () {
                    mensaje("Error de conexion");
                    recursosSolicitados = false;
                });
            }
            ;
            function setRecursosDescargados(booleanValue) {
                recursosDescargados = booleanValue;
            }
            ;
            function enterGame(token) {
                userId = token;
                if (recursosSolicitados) {
                    if (recursosDescargados) {
                        openSocket(token);
                    } else {
                        mensajeAppend(".");
                        setTimeout(enterGame, 100, token);
                    }
                } else {
                    descargarRecursos();
                    enterGame(token);
                }
            }
            ;
            function login(username, pass) {
                var data = {username: username, pass: pass};
                $.post('http://' + window.location.host + '/login', JSON.stringify(data))
                        .done(function (data) {
                            var reply = JSON.parse(data);
                            var status = reply.status;
                            var code = reply.code;
                            var content = reply.content;
                            if (status) {
                                enterGame(content);
                            } else {
                                $("#loginButton").prop('disabled', false);
                                mensaje(content);
                            }
                        }).fail(function () {
                    $("#loginButton").prop('disabled', false);
                    mensaje("Error de conexion");
                });
            }
            ;
            function unregisterClick() {
                $("#unregisterButton").prop('disabled', true);
                var username = $("#usernameInput").val();
                var pass = $("#passInput").val();
                if (username.length === 0 || pass.length === 0) {
                    mensaje('Debe escribir usuario y clave');
                    $("#unregisterButton").prop('disabled', false);
                    return;
                }

                var param = prompt("Si desea eliminar el usuario, ingrese nuevamente la clave");
                if (param != null && param === pass) {
                    unregister(username, pass);
                } else {
                    $("#unregisterButton").prop('disabled', false);
                    mensaje("No se eliminara el usuario");
                }
            }
            function registerClick() {
                $("#registerButton").prop('disabled', true);
                var username = $("#usernameInput").val();
                var pass = $("#passInput").val();
                if (username.length === 0 || pass.length === 0) {
                    mensaje('Debe escribir usuario y clave');
                    $("#registerButton").prop('disabled', false);
                    return;
                }
                if (username.startsWith('_')) {
                    mensaje('El nombre de usuario no puede comenzar con "_"');
                    $("#registerButton").prop('disabled', false);
                    return;
                }
                register(username, pass);
            }
            ;
            function loginClick() {
                $("#loginButton").prop('disabled', true);
                var username = $("#usernameInput").val();
                var pass = $("#passInput").val();
                if (username.length === 0 || pass.length === 0) {
                    mensaje('Debe escribir usuario y clave');
                    $("#loginButton").prop('disabled', false);
                    return;
                }
                login(username, pass);
            }
            ;
            function unregister(username, pass) {
                var data = {username: username, pass: pass};
                $.post('http://' + window.location.host + '/unregister', JSON.stringify(data))
                        .done(function (data) {
                            var reply = JSON.parse(data);
                            var status = reply.status;
                            var code = reply.code;
                            var content = reply.content;
                            $("#unregisterButton").prop('disabled', false);
                            mensaje(content);
                        }).fail(function () {
                    $("#unregisterButton").prop('disabled', false);
                    mensaje("Error de conexion");
                });
            }
            ;
            function register(username, pass) {
                var data = {username: username, pass: pass};
                $.post('http://' + window.location.host + '/register', JSON.stringify(data))
                        .done(function (data) {
                            var reply = JSON.parse(data);
                            var status = reply.status;
                            var code = reply.code;
                            var content = reply.content;
                            $("#registerButton").prop('disabled', false);
                            mensaje(content);
                        }).fail(function () {
                    $("#registerButton").prop('disabled', false);
                    mensaje("Error de conexion");
                });
            }
            ;
        </script>
        <style>
            .invalid-blink {
                background-color: blue;
            }
            .thick-bordered {
                border: 5px solid black;
                border-collapse: collapse;
            }
            .padded {
                padding: 10px;
            }
            .bordered {
                border: 1px solid black; 
                border-collapse: collapse;
            }
            .transparent {
                opacity: 0.5;
            }
            .crossed
            {
                background-image: linear-gradient(to bottom right,  transparent calc(50% - 1px), black, transparent calc(50% + 1px)); 
            }
        </style>
    </head>
    <body onload="onLoadFunction()">
        <div id="masterContainer">
            <div id="responseContainer">-</div>
            <div id="chatContainerOld">-</div>
            <div id="chatContainerNew">-</div>
            <div id="loginContainer">
                <div>
                    Usuario
                    <input id="usernameInput" maxlength="20"/>
                </div><br>
                <div>
                    Clave
                    <input id="passInput" maxlength="20"/>
                </div><br><div>
                    <button id="loginButton" onclick="loginClick()">
                        Entrar
                    </button>
                    <button id="registerButton" onclick="registerClick()">
                        Registrarse
                    </button>
                    <button id="unregisterButton" onclick="unregisterClick()">
                        Eliminar usuario
                    </button>
                </div>
                <br>
                <div>O ingresar como espectador</div>
                <br>
                <div>
                    <button id="spectatorButton" onclick="spectatorButtonClick()">
                        Ingresar como espectador
                    </button>
                </div>
            </div>
            <div id="pregameContainer">
                <div>Esperando otros jugadores. Presionar el botón para solicitar iniciar.</div>
                <div>Cuando todos los jugadores presionen el botón, el juego comenzará.</div>
                <br>
                <button id="solicitarIniciarButton" onclick="solicitarIniciarClick()">
                    Solicitar inicio con los que estamos
                </button>
                <button disabled id="leaderboardButton" onclick="leaderboardButtonClick()">
                    Estadisticas
                </button>
                <br>
                <div id="configInfo">Juego aun no configurado.</div>
                <div id="configDiv"> Barajas
                    <select id="cantBarajas" onChange="cambiarMaximoBazasPosible()">
                        <option>1</option>
                        <option>2</option>
                        <option>3</option>
                    </select>
                    <input id="ultimaRondaIndiaChk" type="checkbox" checked> Ultima ronda india
                    Cantidad Maxima de Bazas
                    <select id="cantBazasMaximaForzada">
                        <option>1</option>
                        <option>2</option>
                        <option>3</option>
                    </select>
                    <button id="configurarJuegoButton" onclick="configurarJuegoClick()">
                        Configurar juego
                    </button>
                </div>
                <br>
                <div id="listaJugadores"></div>
            </div>
            <div id="tableContainer">-</div>
            <div id="gameContainer">
                <div>Juego</div>
            </div>
        </div>
        <div id="audioDiv"></div>
    </body>
</html>